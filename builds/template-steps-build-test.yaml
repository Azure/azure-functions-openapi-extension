parameters:
  configuration: ''
  isWindows: false

steps:
- task: NodeTool@0
  displayName: 'Install node.js 14'
  inputs:
    versionSpec: '14.x'

- task: PowerShell@2
  displayName: 'Install Azure Functions Core Tools'
  inputs:
    targetType: Inline
    script: |
      npm install -g azure-functions-core-tools@3 --unsafe-perm true

- task: UseDotNet@2
  displayName: 'Install .NET Core SDK 2.1 LTS'
  inputs:
    version: '2.1.x'

- task: UseDotNet@2
  displayName: 'Install .NET Core SDK 3.1 LTS'
  inputs:
    version: '3.1.x'

- task: UseDotNet@2
  displayName: 'Install .NET SDK 5'
  inputs:
    version: '5.x'

- task: DotNetCoreCLI@2
  displayName: '.NET Restore'
  inputs:
    command: restore
    projects: '$(System.DefaultWorkingDirectory)/*.sln'
    verbosityRestore: Quiet

- task: DotNetCoreCLI@2
  displayName: '.NET Build'
  inputs:
    projects: '$(System.DefaultWorkingDirectory)/*.sln'
    arguments: '-c ${{ parameters.configuration }}'

- task: DotNetCoreCLI@2
  displayName: '.NET Test'
  inputs:
    command: test
    projects: '$(System.DefaultWorkingDirectory)/test/**/*.csproj'
    arguments: '-c ${{ parameters.configuration }} /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:CoverletOutput=$(System.DefaultWorkingDirectory)\TestResults\coverage'
    publishTestResult: true

- task: PowerShell@2
  displayName: '.NET Integration Test (Windows)'
  condition: eq(${{ parameters.isWindows }}, true)
  inputs:
    targetType: Inline
    script: |
      $func = $(Get-Command func).Source.Replace(".ps1", ".cmd")

      cd $(System.DefaultWorkingDirectory)/test-integration/Microsoft.Azure.WebJobs.Extensions.OpenApi.TestApp
      Start-Process -NoNewWindow "$func" @("start","--verbose","false")
      Start-Sleep -s 60

      cd $(System.DefaultWorkingDirectory)/test-integration/Microsoft.Azure.WebJobs.Extensions.OpenApi.Document.Tests
      dotnet test . -c ${{ parameters.configuration }} --logger "trx;LogFileName=$(System.DefaultWorkingDirectory)\TestResults\TestResult.trx"

      cd $(System.DefaultWorkingDirectory)

- task: PowerShell@2
  displayName: '.NET Integration Test (Non-Windows)'
  condition: eq(${{ parameters.isWindows }}, false)
  inputs:
    targetType: Inline
    script: |
      cd $(System.DefaultWorkingDirectory)/test-integration/Microsoft.Azure.WebJobs.Extensions.OpenApi.TestApp
      Start-Process -NoNewWindow func @("start","--verbose","false")
      Start-Sleep -s 60

      cd $(System.DefaultWorkingDirectory)/test-integration/Microsoft.Azure.WebJobs.Extensions.OpenApi.Document.Tests
      dotnet test . -c ${{ parameters.configuration }} --logger "trx;LogFileName=$(System.DefaultWorkingDirectory)\TestResults\TestResult.trx"

      cd $(System.DefaultWorkingDirectory)

- task: PowerShell@2
  displayName: 'Save Test Run Status'
  inputs:
    targetType: Inline
    script: 'Write-Host "##vso[task.setvariable variable=TestRunStatus]$(Agent.JobStatus)"'

- task: PublishCodeCoverageResults@1
  displayName: 'Publish Code Coverage Results'
  inputs:
    codeCoverageTool: Cobertura
    summaryFileLocation: '$(System.DefaultWorkingDirectory)\TestResults\*.xml'
    failIfCoverageEmpty: false

- task: PowerShell@2
  displayName: 'Cancel Pipeline on Test Run Failure'
  condition: and(succeeded(), or(eq(variables['TestRunStatus'], 'Failed'), eq(variables['TestRunStatus'], 'SucceededWithIssues')))
  inputs:
    targetType: Inline
    script: |
      Write-Host "##vso[task.setvariable variable=Agent.JobStatus]Failed"
      Write-Host "##vso[task.complete result=Failed]DONE"
